# Tips

## 試験について

- 問題の難易度はバラバラに出てくる。
  - 最後の方で「こういうDeploymentを作れ」みたいな簡単な問題が出ることもある。
- 各問題には配点が書かれている。
- 各問題にフラグ（マーク）を付けて、あとで振り返れるようになっている。
- いつでも任意の問題に行ったり来たりできる。

問題は関連性なくバラバラに並んでいるので、自分の解けるものからどんどんやって、1周してから難しかった問題に取り組むのがよい。

### 気をつけること

- クラスタを間違えない。
  - タスク切り替える毎に毎回冒頭の`use-context`のやつコピペして実行でよい。
- ノードに`ssh`したあとはきちんと親ターミナルに戻っておく。
  - 気づくとどっかのノードの上で`k`とか打ってたりする。
  - ただし、間違って親ターミナルまで抜けないように気をつけなければいけない。
- `tmux`を使ってるときは各ペインがどこにいるか特に気をつける。
- とにかく`namespace`と`name`を指定されるので、間違えないようにする。
- タイプミスの防止と時間節約のためにも、基本的に問題文からコピペしたほうがよい（クリックするだけでコピーできるようになってる）
- 問題文の要件が達成されているかきちんと確認する。
  - ただし、確認に時間を書けすぎないように注意する。
  - 最低限、`describe`や`get`でざっとおかしなところがないかぐらいは確認したほうがよい。

## Chromeの設定

普段のものとは別に試験用のプロファイルを作る。

- 余計な機能拡張などの入っていない綺麗なプロファイルを新しく作る。
- 新しく作ったプロファイルで試験環境のチェックを行う。
  - チェック時に要求される機能拡張(`Innovative Exams Screensharing`等)もこのプロファイルに入れ直す。
- Kubernetes公式ドキュメントから、自分に必要そうなページを片っ端からブックマークしておく。
  - 自分で見た時に分かりやすいタイトルに変更しておくと見つけやすくなる。
    - 例: `etcdのバックアップとリストア`
  - `kubectl create`で作れないタイプのリソース（`PersistentVolume`等）のサンプルが載っているページはブックマークしておいたほうがよい。

## テキストエディタの設定

デフォルト環境だとコマンドによって`nano`が立ち上がったり`vim`が立ち上がったり様々なので、`EDITOR`環境変数で設定しておくとよい。

```bash
# vimにする
export EDITOR=vim

# nanoにする
export EDITOR=nano
```

また、`KUBE_EDITOR`環境変数に設定すれば、`kubectl edit`の時のエディタだけ変えることも出来る（設定されていなければ`EDITOR`が参照される）。

### Vimの設定

デフォルト状態だとマニフェストのYAMLを編集するのに向いてないので、以下のような設定を作ると多少マシになる。
（試験環境でもソラで作れそうなミニマルな設定内容）

`~/.vimrc`

```vim
source $VIMRUNTIME/defaults.vim
set number
set ts=2 sts=2 sw=2 et
```

あるいは

```vim
filetype plugin indent on
syntax on
set number
set ts=2 sts=2 sw=2 et
```

## tmuxの使い方

デフォルト設定のままのtmuxの使い方。

### マウスを有効にする

**マウスを有効にするとコピペができなくなる場合があるので、tmuxを使いこなしている人以外はおすすめできない。**

tmuxでマウスを使うには、ターミナルソフトもマウス入力に対応している必要がある。

**注意：試験環境のWebターミナルでマウスが有効化できるかどうかはわからない。**

1. `C-b :`でコマンド入力モードにする
2. vimみたいに画面下でコマンドを入力できるモードになるので`set mouse`を実行する

マウスを有効にすると何ができるのか:

- 画面分割したペインをマウスクリックでフォーカス切り替え
- 画面分割したペインの中でホイールスクロール
- 画面分割の線をドラッグしてペインをリサイズ

ただし、マウスを有効にするとターミナルに対するコピペがうまくできなくなる。その場合は、一時的に`set mouse`でオンオフ切り替えながら利用する。

### 最低限バージョン

```
プレフィックスキーはC-b

C-b ?               キーマッピング一覧を表示
                    ただし見てもよくわからないものが多い

ウィンドウ
タブみたいなもの
今自分がどのウィンドウにいるかは、画面下のタブ名に*がついてるかどうかでわかる
C-b c               新規ウィンドウ作成
C-b n               次のウィンドウに切り替え
C-b p               前のウィンドウに切り替え
C-b w               ウィンドウ一覧から選択して切り替え
                    左右キーでツリーを展開してペインの切り替えもできる
C-b "               ウィンドウを水平に分割
C-b %               ウィンドウを垂直に分割

ペイン関係
ウィンドウの中にある個々の領域（画面分割していないときも1つだけのペイン）
C-b o               次のペインに切り替え
C-b ;               直前のペインに切り替え
C-b カーソルキー      ペインの切り替え
```

### これだけ知ってたら十分バージョン

```
プレフィックスキーはC-b

C-b ?               キーマッピング一覧を表示
                    ただし見てもよくわからないものが多い
C-b d               クライアントのデタッチ
                    tmux attachで再アタッチできる
C-b :               tmuxのコマンド入力モード
                    ここでselect-windowとかコマンド使ってもいい
C-b t               時計を表示

ウィンドウ
タブみたいなもの
今自分がどのウィンドウにいるかは、画面下のタブ名に*がついてるかどうかでわかる
C-b c               新規ウィンドウ作成
C-b n               次のウィンドウに切り替え
C-b p               前のウィンドウに切り替え
C-b 0..9            指定の番号のウィンドウに切り替え
C-b w               ウィンドウ一覧から選択して切り替え
                    左右キーでツリーを展開してペインの切り替えもできる
C-b "               ウィンドウを水平に分割
C-b %               ウィンドウを垂直に分割

ペイン関係
ウィンドウの中にある個々の領域（画面分割していないときも1つだけのペイン）
C-b o               次のペインに切り替え
C-b ;               直前のペインに切り替え
C-b カーソルキー      ペインの切り替え
C-b z               現在のペインを最大化（もう一度実行すると元に戻る）
C-b {               ペインの入れ替え
C-b }               ペインの入れ替え
C-b Space           ペインのレイアウトを順番に切り替える（5種類ぐらいある）
C-b Alt-1           均等な水平分割レイアウトに切り替え
C-b Alt-2           均等な垂直分割レイアウトに切り替え
C-b Alt-3           メインとサブの水平分割レイアウトに切り替え
C-b Alt-4           メインとサブの垂直分割レイアウトに切り替え
C-b Alt-5           タイル型のレイアウトに切り替え
C-b C-カーソルキー    ペインのリサイズ
C-b Alt-カーソルキー  ペインのリサイズ（5文字幅ずつ）
```

### tmuxで画面分割するとはかどる

1. `C-b "`で水平分割する
2. 上ペインで`watch kubectl get deploy,po,svc -o wide --show-labels` などを実行しっぱなしにする
3. 状況がリアルタイムに把握できる👍

### 分割したペインを一時的に最大化する

`C-b z`で現在のペインを最大化できる。もう一度実行すると元に戻る。

### tmuxの設定

`~/.tmux.conf`に以下のような設定を書く。
内容は各自の好みに合わせて変更すること。

```
# tmux上での$TERMの設定
# screen-256colorにしないとプロンプトがカラーで表示されないので見づらい
set -g default-terminal screen-256color

# プレフィクスキーをC-tに変更する
# C-bをカーソルを左に動かすのに使ってる人は変更したほうがよい
set -g prefix C-t
bind-key C-t send-prefix
unbind-key C-b

# コピーモードの操作をviライクにする
setw -g mode-keys vi
```

## リソースまわり

### ドキュメントからマニフェストをコピペするとき

vimでそのままペーストすると（おそらく）インデントが崩れると思うので、そういう場合は`cat - >foo.yaml`で作るのがおすすめ。
あるいは`nano`を使う等でもよい。

```bash
cat - >foo.yaml
# 入力待ちになるのでペーストする
# （必要があれば改行して）行の頭でCtrl+Dを入力する
```

### Roleの作成はコマンドからやったほうがよい

`Role`のマニフェストは`resources`によって`apiGroups`を分けて書かなければならないので、どのリソースがどのグループに属するのかを把握していなければいけないが、コマンドで作成すると自動的に分類されて作成してくれる。

```bash
kubectl create role --resource=pods,deploy --verb=get
```

## kubectl小ネタ

### コマンドのヘルプ

`-h`をつければ大抵のサブコマンドはヘルプが出てくる。

```bash
kubectl get -h
kubeclt create -h
kubeclt create deploy -h
```

### ヘルプの中のExampleだけさっと見たい

```bash
# Examples:の行から下20行を表示
# 20の部分は適当に変えてもよい
kubectl get -h | grep Examples -A 20
```

### マニフェストの項目を調べる

`kubectl explain`で調べられる。

```bash
kubectl explain pod
kubectl explain pod.spec.containers
```

また、`kubectl explain --recursive`でツリー構造の表示ができる。
項目がどの階層だったか確認するのに便利。

### `--all-namespaces`って打つのだるい

`-A`でもよい。

```bash
kubectl get pods --all-namespaces
kubectl get po -A
```

### `po`とか`svc`みたいな省略形を知りたい

`kubectl api-resources`で一覧表示できる。

APIのバージョンも表示されるので、微妙にバージョンが違って、`v1beta1`って指定したら`DEPRECATED`と怒られた、などという場合に確認できる。
というか、そういう場合は`kubectl explain`でマニフェストの項目を確認したほうがよい（バージョンも確認できる）。

### --dry-run=client -o yamlって打つのだるい

変数を使って入力を楽にするテクニックがある。
試験時には特に有効。

```bash
export do="--dry-run=client -o yaml"
k run app --image=nginx $do >nginx-app.yaml
```

ただしtmuxを使う場合は、tmuxを起動する前に環境変数をエクスポートしておかないと、新しいペインを作った際に変数が未定義になっていて事故るので注意。

### Podの削除が遅い

以下のオプションで強制削除できる。

```bash
kubectl delete pods <pod> --grace-period=0 --force
```

これも変数を使ったテクニックがある。試験時に有効。

```bash
export now="--force --grace-period 0"
k delete po mypod $now
```

ただし、実環境などでむやみに使用すると良くない。詳細は[Force Delete StatefulSet Pods](https://kubernetes.io/docs/tasks/run-application/force-delete-stateful-set-pod/#force-deletion)を参照。
